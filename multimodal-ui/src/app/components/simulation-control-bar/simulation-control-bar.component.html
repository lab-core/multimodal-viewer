@let isSimulationPaused = isSimulationPausedSignal();
@let isVisualizationPaused = isVisualizationPausedSignal();
@let simulation = simulationInputSignal();
@let simulationStartTime = simulationStartTimeSignal();
@let simulationEndTime = simulationEndTimeSignal();
@let visualizationMaxTime = visualizationMaxTimeSignal();
@let visualizationTime = wantedVisualizationTimeSignal();
@let simulationStates = simulationStatesSignal();

@let isInitialized = isInitializedSignal();

@let shouldFollowEntity = shouldFollowEntitySignal();

@if (
  isInitialized &&
  simulation !== null &&
  simulationStartTime !== null &&
  simulationEndTime !== null &&
  visualizationMaxTime !== null &&
  visualizationTime !== null
) {
  <mat-card>
    <mat-card-content class="flex-row align-center gap-0-5-rem">
      <button
        mat-icon-button
        [matTooltip]="
          isVisualizationPaused
            ? 'Resume the visualization'
            : 'Pause the visualization'
        "
        (click)="toggleVisualizationPause(isVisualizationPaused)"
      >
        <mat-icon>{{
          isVisualizationPaused ? "play_arrow" : "pause"
        }}</mat-icon>
      </button>

      @if (isVisualizationPaused) {
        <button
          mat-icon-button
          disabled
          [matTooltip]="'Step one event backward'"
        >
          <mat-icon>skip_previous</mat-icon>
        </button>
        <button
          mat-icon-button
          disabled
          [matTooltip]="'Step one event forward'"
        >
          <mat-icon>skip_next</mat-icon>
        </button>
      }

      @let speed = speedSignal();
      @let canIncreaseSpeed = canIncreaseSpeedSignal();
      @let canDecreaseSpeed = canDecreaseSpeedSignal();
      <button
        mat-icon-button
        [disabled]="!canDecreaseSpeed"
        [matTooltip]="'Slow down the simulation'"
        (click)="decreaseSpeed()"
      >
        <mat-icon>fast_rewind</mat-icon>
      </button>
      <div class="speed">x{{ speed }}</div>
      <button
        mat-icon-button
        [disabled]="!canIncreaseSpeed"
        [matTooltip]="'Speed up the simulation'"
        (click)="increaseSpeed()"
      >
        <mat-icon>fast_forward</mat-icon>
      </button>

      <button
        mat-icon-button
        [matTooltip]="
          speed > 0 ? 'Reverse the simulation' : 'Forward the simulation'
        "
        [disabled]="speed === 0"
        (click)="toggleSimulationDirection()"
      >
        <mat-icon>{{ speed > 0 ? "restore" : "update" }}</mat-icon>
      </button>

      <button
        mat-icon-button
        [matTooltip]="'Center the map'"
        (click)="centerMap()"
      >
        <mat-icon>my_location</mat-icon>
      </button>

      <button
        mat-icon-button
        [matTooltip]="'Toggle entity follow mode'"
        [class.active]="shouldFollowEntity"
        (click)="toggleShouldFollowEntity()"
      >
        <mat-icon>moving</mat-icon>
      </button>

      <div
        [matTooltip]="((visualizationTime | number: '1.0-0') ?? '0').toString()"
      >
        {{ visualizationTime | simulationTime }}
      </div>

      <div class="flex-1 sliders">
        <!-- Main control slider -->
        <mat-slider
          discrete
          [displayWith]="
            sliderLabelFormatter(simulationStartTime, simulationEndTime)
          "
          [min]="simulationStartTime"
          [max]="simulationEndTime"
        >
          <input
            matSliderThumb
            [value]="visualizationTime"
            (valueChange)="onSliderChange($event)"
          />
        </mat-slider>

        <!-- Loaded parts of the simulation -->
        @if (
          simulationStates.firstContinuousState !== null &&
          simulationStates.lastContinuousState !== null
        ) {
          <mat-slider
            class="loaded"
            disabled
            [min]="simulationStartTime"
            [max]="simulationEndTime"
          >
            <input
              matSliderStartThumb
              [value]="simulationStates.firstContinuousState.timestamp"
            />
            <input
              matSliderEndThumb
              [value]="simulationStates.lastContinuousState.timestamp"
            />
          </mat-slider>
        }

        @if (simulation.simulationTime !== null) {
          <!-- Simulation time -->
          <mat-slider
            class="simulation disable-pointer-events"
            disabled
            [min]="simulationStartTime"
            [max]="simulationEndTime"
          >
            <input matSliderThumb [value]="simulation.simulationTime" />
          </mat-slider>
        }
      </div>

      @if (simulation.status === "running" || simulation.status === "paused") {
        <button
          mat-icon-button
          [matTooltip]="
            isSimulationPaused
              ? 'Resume the simulation'
              : 'Pause the simulation'
          "
          (click)="toggleSimulationPause(isSimulationPaused, simulation.id)"
        >
          <mat-icon>{{ isSimulationPaused ? "play_arrow" : "pause" }}</mat-icon>
        </button>

        <button
          mat-icon-button
          [matTooltip]="'Stop the simulation'"
          (click)="stopSimulation(simulation.id)"
        >
          <mat-icon>stop</mat-icon>
        </button>
      }

      <button
        mat-icon-button
        [matTooltip]="'Configure the simulation'"
        (click)="editSimulationConfiguration(simulation)"
      >
        <mat-icon>settings</mat-icon>
      </button>

      <button
        mat-icon-button
        [matTooltip]="'Leave the visualization'"
        (click)="leaveVisualization()"
      >
        <mat-icon>exit_to_app</mat-icon>
      </button>
    </mat-card-content>
  </mat-card>
}
