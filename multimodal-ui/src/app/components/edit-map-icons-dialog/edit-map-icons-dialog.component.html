<h1 mat-dialog-title>Customize Entities</h1>

<mat-dialog-content>
  <!-- MARK: Edit Icons
  -->
  <h2>Edit Icons</h2>

  <input
    #iconFileUpload
    type="file"
    class="file-upload"
    accept=".png, .jpg, .jpeg, .bmp"
    (change)="onIconFileUpload($event)"
  />
  <input
    #configurationFileUpload
    type="file"
    class="file-upload"
    accept=".json"
    (change)="onConfigurationFileUpload($event)"
  />

  <div>
    <div class="text-content">
      <p>The icons should not be too wide or too thin.</p>

      <p>
        The uploaded icons will be rescaled to {{ SPRITE_SIZE }}px in width.
      </p>

      <p>
        The icons are in decreasing order of priority, meaning that if two icons
        match for an entity, the one that appears first in the list will be
        used. You can drag and drop the icons lines to change their order.
      </p>

      @if (currentError !== "") {
        <mat-error>{{ currentError }}</mat-error>
      }
    </div>

    <div class="add-container">
      <button class="add-button" mat-button (click)="addCustomTexture()">
        Add Custom Icon
      </button>
    </div>

    @if (customTexturesSignal().length === 0) {
      <p>You have no custom icons.</p>
    }

    <section
      class="icon-list"
      cdkDropList
      cdkDropListOrientation="vertical"
      (cdkDropListDropped)="dropCustomTexture($event)"
    >
      <!-- MARK: +- Custom Icons
      -->
      @for (customTexture of customTexturesSignal(); track $index) {
        <div class="icon-list-item" cdkDrag>
          <!-- Placeholder
          -->
          <div
            *cdkDragPlaceholder
            class="icon-placeholder-container icon-list-item"
          >
            <div class="icon-placeholder icon"></div>

            <div class="icon-button-placeholder"></div>

            <div class="form-fields">
              <div class="form-field-row">
                <div
                  class="form-field-placeholder custom-icon-form-field"
                ></div>

                <div
                  class="form-field-placeholder custom-icon-form-field"
                ></div>

                @if (customTexture.type === "vehicle") {
                  <div
                    class="form-field-placeholder custom-icon-form-field"
                  ></div>
                }
              </div>

              <div class="form-field-row">
                <div
                  class="form-field-placeholder custom-icon-form-field"
                ></div>
              </div>
            </div>

            <div class="icon-button-placeholder"></div>
          </div>

          <!-- Actual Icon
          -->
          <div class="icon">
            <img width="40" alt="icon" [src]="customTexture.url" />
          </div>

          <button
            mat-icon-button
            matTooltip="Upload image"
            (click)="uploadCustomTexture($index)"
          >
            <mat-icon>upload</mat-icon>
          </button>

          <div class="form-fields">
            <div class="form-field-row">
              <mat-form-field
                class="compact-input custom-icon-form-field"
                appearance="outline"
                subscriptSizing="dynamic"
              >
                <mat-label>Type</mat-label>
                <mat-select [(value)]="customTexture.type">
                  @for (
                    customTextureType of CUSTOM_TEXTURE_TYPES;
                    track $index
                  ) {
                    <mat-option [value]="customTextureType">
                      {{ customTextureType.replaceAll("-", " ") | titlecase }}
                    </mat-option>
                  }
                </mat-select>
              </mat-form-field>

              <mat-form-field
                class="compact-input custom-icon-form-field"
                appearance="outline"
                subscriptSizing="dynamic"
              >
                <mat-label>Zoom</mat-label>
                <mat-select [(value)]="customTexture.zoom">
                  @for (
                    customTextureZoom of CUSTOM_TEXTURE_ZOOMS;
                    track $index
                  ) {
                    <mat-option [value]="customTextureZoom">
                      {{ customTextureZoom.replaceAll("-", " ") | titlecase }}
                    </mat-option>
                  }
                </mat-select>
              </mat-form-field>

              @if (customTexture.type === "vehicle") {
                <mat-form-field
                  class="compact-input custom-icon-form-field"
                  appearance="outline"
                  subscriptSizing="dynamic"
                >
                  <mat-label>Vehicle Mode</mat-label>
                  <input matInput [(ngModel)]="customTexture.mode" />
                </mat-form-field>
              }
            </div>

            <div class="form-field-row">
              <mat-form-field
                class="compact-input custom-icon-form-field"
                appearance="outline"
                subscriptSizing="dynamic"
              >
                <mat-label>Tags</mat-label>
                <mat-chip-grid #chipGrid aria-label="Enter fruits">
                  @for (tag of customTexture.tags; track tag) {
                    <mat-chip-row
                      [aria-description]="'press enter to edit ' + tag"
                      [editable]="true"
                      (removed)="removeTagFromCustomTexture($index, tag)"
                      (edited)="editTagInCustomTexture($index, tag, $event)"
                    >
                      {{ tag }}
                      <button matChipRemove [attr.aria-label]="'remove ' + tag">
                        <mat-icon>cancel</mat-icon>
                      </button>
                    </mat-chip-row>
                  }
                  <input
                    [matChipInputAddOnBlur]="true"
                    [matChipInputFor]="chipGrid"
                    (matChipInputTokenEnd)="
                      addTagToCustomTexture($index, $event)
                    "
                  />
                </mat-chip-grid>
              </mat-form-field>
            </div>
          </div>

          <button
            mat-icon-button
            [matTooltip]="'Remove custom icon'"
            (click)="removeCustomTexture($index)"
          >
            <mat-icon>cancel</mat-icon>
          </button>
        </div>
      }

      <mat-divider></mat-divider>
    </section>

    <section class="icon-list">
      <!-- MARK: +- Default Icons
      -->
      @for (
        defaultIconType of EDITABLE_DEFAULT_ICON_TYPES;
        track defaultIconType
      ) {
        @let url = getTextureUrlSignal(defaultIconType)();
        <div class="icon-list-item">
          <div class="icon">
            <img width="40" alt="icon" [src]="url" />
          </div>

          <button
            mat-icon-button
            matTooltip="Upload image"
            (click)="uploadDefaultTexture(defaultIconType)"
          >
            <mat-icon>upload</mat-icon>
          </button>

          <mat-form-field
            class="compact-input default-icon-type"
            appearance="outline"
            subscriptSizing="dynamic"
          >
            <input
              matInput
              disabled
              value="Default {{
                defaultIconType.replaceAll('-', ' ') | titlecase
              }} Icon"
            />
          </mat-form-field>

          <button
            mat-icon-button
            matTooltip="Reset icon"
            (click)="resetDefaultTexture(defaultIconType)"
          >
            <mat-icon>restart_alt</mat-icon>
          </button>
        </div>
      }

      <mat-divider></mat-divider>

      <!-- MARK: Colors
      -->
      <h2>Capacity color gradient</h2>

      <mat-radio-group
        class="color-group"
        [(ngModel)]="colorPresetIndex"
        (change)="onColorSetIndexChange($event)"
      >
        <mat-radio-button [value]="0">Light</mat-radio-button>
        <mat-radio-button [value]="1">Saturated</mat-radio-button>
        <mat-radio-button [value]="2">Custom</mat-radio-button>
      </mat-radio-group>

      @if (colorPresetIndex === 0) {
        <div class="color-list-container">
          <span>Light Preset:</span>
          @for (color of PRESET_LIGHT_COLOR_THEME; track $index) {
            <div class="preset-color" [style.background-color]="color"></div>
          }
        </div>
      }

      @if (colorPresetIndex === 1) {
        <div class="color-list-container">
          <span>Saturated Preset:</span>
          @for (color of PRESET_SATURATED_COLOR_THEME; track $index) {
            <div class="preset-color" [style.background-color]="color"></div>
          }
        </div>
      }

      @if (colorPresetIndex === 2) {
        <div class="color-list-container">
          <span>Custom:</span>
          <button
            class="mini-icon-button"
            mat-icon-button
            [disabled]="!canRemoveColor()"
            (click)="removeCustomColor()"
          >
            <mat-icon>remove_circle_outline</mat-icon>
          </button>

          <div
            class="custom-color-list"
            cdkDropList
            cdkDropListOrientation="horizontal"
            (cdkDropListDropped)="dropCustomColor($event)"
          >
            @for (color of customColors(); track $index) {
              <div class="custom-color" cdkDrag>
                <div *cdkDragPlaceholder class="color-placeholder"></div>
                <input
                  class="color-picker"
                  type="color"
                  [value]="color"
                  (input)="onColorChange($index, $event)"
                />
              </div>
            }
          </div>
          <button
            class="mini-icon-button"
            mat-icon-button
            [disabled]="!canAddColor()"
            (click)="addCustomColor()"
          >
            <mat-icon>add_circle_outline</mat-icon>
          </button>
        </div>
        <span>*Click to set their color. Drag to change their order.</span>
      }
      <span>*Test the color gradient using the slider below.</span>

      <div class="color-tester">
        <div class="icon wrapper-icon">
          <img width="40" alt="icon" [src]="vehicleTextureUrl()" />
          <div
            class="color-overlay"
            [style.background-color]="testScaleColor"
            [style.mask-image]="'url(' + vehicleTextureUrl() + ')'"
            [style.webkitMaskImage]="'url(' + vehicleTextureUrl() + ')'"
          ></div>
        </div>

        <div class="icon wrapper-icon">
          <img width="40" alt="icon" [src]="stopWithPassengerTextureUrl()" />
          <div
            class="color-overlay"
            [style.background-color]="testScaleColor"
            [style.mask-image]="'url(' + stopWithPassengerTextureUrl() + ')'"
            [style.webkitMaskImage]="
              'url(' + stopWithPassengerTextureUrl() + ')'
            "
          ></div>
        </div>

        <div class="icon wrapper-icon">
          <img width="40" alt="icon" [src]="zoomedOutVehicleTextureUrl()" />
          <div
            class="color-overlay"
            [style.background-color]="testScaleColor"
            [style.mask-image]="'url(' + zoomedOutVehicleTextureUrl() + ')'"
            [style.webkitMaskImage]="
              'url(' + zoomedOutVehicleTextureUrl() + ')'
            "
          ></div>
        </div>

        <div class="icon wrapper-icon">
          <img
            width="40"
            alt="icon"
            [src]="zoomedOutStopWithPassengerTextureUrl()"
          />
          <div
            class="color-overlay"
            [style.background-color]="testScaleColor"
            [style.mask-image]="
              'url(' + zoomedOutStopWithPassengerTextureUrl() + ')'
            "
            [style.webkitMaskImage]="
              'url(' + zoomedOutStopWithPassengerTextureUrl() + ')'
            "
          ></div>
        </div>

        <mat-slider min="0" max="100" discrete showTickMarks>
          <input matSliderThumb (input)="onColorScaleChange($event)" />
        </mat-slider>
      </div>
    </section>
  </div>
</mat-dialog-content>

<mat-dialog-actions>
  <div class="file-porters">
    <button mat-icon-button matTooltip="Export JSON" (click)="exportTextures()">
      <mat-icon>download_for_offline</mat-icon>
    </button>
    <button
      mat-icon-button
      matTooltip="Import JSON"
      (click)="configurationFileUpload.click()"
    >
      <mat-icon>upload_file</mat-icon>
    </button>
  </div>

  <button mat-button mat-dialog-close>Cancel</button>
  <button mat-button (click)="onSave()">Save</button>
</mat-dialog-actions>
